<?php 
	include_once 'valve.php';
	if (isset($_GET["Valve"]) && !empty($_POST)) {
		$Valve = GetValvesList()[$_GET["Valve"]];
		if (isset($_POST["Open"])) {
			$Valve->ManualOpenNow();
		} elseif (isset($_POST["Close"])) {
			$Valve->DoClose();
		} elseif (isset($_POST["Save"])) {
			$Valve->UpdateParamsFromForm();
		}
		// Only POST once:
		sleep(2);
		header("Location: http://$_SERVER[HTTP_HOST]/index.html"); // Redirect browser
		exit;      // Make sure that code below does not get executed when we redirect
	}
?>
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<title>Michaeli's PI Irrigation</title>
	<link href="css/style.css" rel="stylesheet" type="text/css" />
	<meta name="keywords" content="raspberry pi irrigation michaeli" />
	<meta name="description" content="Irrigation system status & control, by Ronen Michaeli 2013" />
</head>
<body>
	<header>
        <div class="logo">
			<h1>Michaeli's PI Irrigation system</h1>
            <a href="index.html"><img src="http://lorempixel.com/300/80/nature" alt="PI Irrigation Logo" /></a>
			<?php new ValveHW() ?>
		</div>
    </header>    
    <div class="content">
		<?php if (isset($_GET["Valve"])) {
			$Valve = GetValvesList()[$_GET["Valve"]];
			$Valve->GenerateParamsForm();
			$menu = false;
		} else {
			echo '<nav class="vertical menu"><ul>';
			$Valves = GetValvesList();
			if (!empty($Valves)) {
				foreach ($Valves as $Key=>$Valve) {
					echo "<li><a href=\"index.html?Valve=$Key\">";
					$Valve->GenerateMainMenuItem();
					echo "</a></li>";
				}
			}
			echo '</ul></nav>';
		} ?>
    </div>
    <footer>
        <p class="copy">
		&copy; 2013 pi.micronen.mooo.com | All right reserved <br/>
		Design By Ronen Michaeli micronen@gmail.com <br/>
		Based on template by <a href="http://www.mobifreaks.com" title="Mobifreaks.com">Mobifreaks.com</a></p>
        <p class="copy">Current time and date: <?=(new DateTime())->format(Valve::DATEFORMAT)?></p>
	</footer>

	<div class="debug">
        <p class="copy">Debug information:</p>
		<?php 
		if (isset($_GET)) { echo '<pre>GET: '; print_r($_GET); echo '</pre>'; }
		if (isset($_POST)) { echo '<pre>POST: '; print_r($_POST); echo '</pre>'; }
		if (isset($Valve)) { echo '<pre>Valve: '; print_r($Valve); echo '</pre>'; }
		if (isset($_SERVER)) { echo '<pre>Server: '; print_r($_SERVER); echo '</pre>'; }
		?>
	</div>
</body>
</html>
	