<?php
	include_once 'ValveDisplay.php';
	include_once 'ValveHW.php';
	
	function GetMainMenu($Valves) {
		echo '<table id="MainMenu" style="width:100%; table-layout:fixed">';
		foreach ($Valves as $Key=>$Valve) {
			echo "<tr><td><button type=submit name=Valve value=\"$Key\" class=menubutton>";
			$Valve->GenerateMainMenuItem();
			echo "</button></td></tr>";
		}
//		echo "<tr><td><p class='copy'>Current time and date: " . (new DateTime())->format(Valve::DATEFORMAT) . "</p></td></tr>";
		echo '</table>';
	}
	
	$Valves = GetValvesList('ValveDisplay');
	if (isset($_REQUEST["MainMenu"])) {
		GetMainMenu($Valves);
		exit;
	}
?>
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<title>Michaeli's PI Irrigation</title>
 	<link href="css/style.css" rel="stylesheet" type="text/css" />
	<meta name="keywords" content="Raspberry PI Irrigation Michaeli" />
	<meta name="description" content="Irrigation system status & control, by Ronen Michaeli 2013" />
	<script type="text/javascript" src="js/jquery-2.0.3.js"></script>
</head>
<body>
	<div class="header">
        <div class="logo">
			<h1>Michaeli's PI Irrigation system</h1>
            <a href="index.html"><img src="images/P2110259_small.jpg" alt="PI Irrigation Logo" /></a>
		</div>
    </div>
    <div class="content"><?php	
		if (!(new ValveHW())->hw_exists()) {
			echo '<h2 style="text-align: center">NO HW FOUND - Simulation mode</h2>' . PHP_EOL;
		}
		if (isset($_REQUEST["Valve"])) {
			// Valve form commands:
			$Valve = $Valves[$_REQUEST["Valve"]];
			$Redirect = true;
			if (isset($_REQUEST["Open"])) {
				$Valve->ManualOpenNow();
			} elseif (isset($_REQUEST["Close"])) {
				$Valve->DoClose();
			} elseif (isset($_REQUEST["Save"])) {
				$Valve->UpdateParamsFromForm();
			} else {
				// Valve params form:
				$Redirect = false;
				echo '<form action="" method="post" name="ValveConfig">';
				$Valve->GenerateParamsForm();
				echo '</form>';
				$Valve->GenerateHistoryTable();
			}
			if ($Redirect) {
				// Only POST once:
				header("Location: http://$_SERVER[HTTP_HOST]/index.html"); // Redirect browser
				exit;      // Make sure that code below does not get executed when we redirect
			}
		} else {
			// Main valves menu
			echo '<form action="" method="post" name="MainValvesMenu">';
			if (!empty($Valves)) {
				GetMainMenu($Valves);
				?>
				<script language="javascript">
					window.setInterval("refreshMainMenu()", 10000);
					function refreshMainMenu() { $('#MainMenu').load('index.html?MainMenu'); }
				</script>
				<?php
			} else {
				echo '<h2 class=txt-center>No valves INI files found, read the Readme file...</h2>';
			}

/*			echo '<table style="width:100%">';
			echo '<tr><td><h3>Default Action: </h3></td><td><select name="DefaultAction">';
			ValveDisplay::SelectArray(['Toggle'=>'Toggle Mode', 'Properties'=>'Properties'],
				isset($_REQUEST['DefaultAction']) ? $_REQUEST['DefaultAction'] : 'Toggle');
			echo '</select></td></tr>';
			echo '</table>';*/

			echo '</form>';
		}
	?> </div>
    <div class="footer">
        <p class="copy">
		&copy; 2013 pi.micronen.mooo.com | All right reserved<br/>
		Design By Ronen Michaeli micronen@gmail.com<br/>
		Based on template by <a href="http://www.mobifreaks.com" title="Mobifreaks.com">Mobifreaks.com</a><br/>
        <p class="copy">Current time and date: <?=(new DateTime())->format(Valve::DATEFORMAT)?></p>
	</div>
<!--
	<div class="debug">
        <p class="copy">Debug information:</p>
		<?php
		if (isset($_GET)) { echo '<pre>GET: '; print_r($_GET); echo '</pre>'; }
		if (isset($_POST)) { echo '<pre>POST: '; print_r($_POST); echo '</pre>'; }
		if (isset($Valve)) { echo '<pre>Valve: '; print_r($Valve); echo '</pre>'; }
		if (isset($_SERVER)) { echo '<pre>Server: '; print_r($_SERVER); echo '</pre>'; }
		?>
	</div>
//-->
</body>
</html>
