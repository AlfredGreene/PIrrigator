<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<title>Michaeli's PI Irrigation</title>
	<link href="css/style.css" rel="stylesheet" type="text/css" />
	<meta name="keywords" content="raspberry pi irrigation michaeli" />
	<meta name="description" content="Irrigation system status & control, by Ronen Michaeli 2013" />
</head>
<body>
	<header>
        <div class="logo">
			<h1>Michaeli's PI Irrigation system</h1>
            <a href="index.html"><img src="http://lorempixel.com/300/80/nature" alt="PI Irrigation Logo" /></a>
		</div>
    </header>    
    <div class="content"><?php 
		include_once 'ValveDisplay.php';
		$Valves = GetValvesDisplayList();
		if (isset($_POST["Valve"])) {
			// Valve form commands:
			$Valve = $Valves[$_POST["Valve"]];
			$Redirect = true;
			if (isset($_POST["Open"])) {
				$Valve->ManualOpenNow();
			} elseif (isset($_POST["Close"])) {
				$Valve->DoClose();
			} elseif (isset($_POST["Save"])) {
				$Valve->UpdateParamsFromForm();
			} else {
				// Valve params form:
				$Redirect = false;
				$Valve->GenerateParamsForm();
				$Valve->GenerateHistoryTable();
			}
			if ($Redirect) { 
				// Only POST once:
				header("Location: http://$_SERVER[HTTP_HOST]/index.html"); // Redirect browser
				exit;      // Make sure that code below does not get executed when we redirect
			}
		} else {
			// Main valves menu
			echo '<form action="" method="post">';
			echo '<table style="width:100%; table-layout:fixed">';
			if (!empty($Valves)) {
				foreach ($Valves as $Key=>$Valve) {
					echo "<tr><td><button type=submit name=Valve value=\"$Key\" class=menubutton>";
					$Valve->GenerateMainMenuItem();
					echo "</button></td></tr>";
				}
			}
			echo '</table>';
			
			echo '<table style="width:100%">';
			echo '<tr><td><h3>Default Action: </h3></td><td><select name="DefaultAction">';
			ValveDisplay::SelectArray(['Toggle'=>'Toggle Mode', 'Properties'=>'Properties'],
				isset($_POST['DefaultAction']) ? $_POST['DefaultAction'] : 'Toggle'); 
			echo '</select></td></tr>';
			echo '</table></form>';
		} 
	?> </div>
    <footer>
        <p class="copy">
		&copy; 2013 pi.micronen.mooo.com | All right reserved <br/>
		Design By Ronen Michaeli micronen@gmail.com <br/>
		Based on template by <a href="http://www.mobifreaks.com" title="Mobifreaks.com">Mobifreaks.com</a></p>
        <p class="copy">Current time and date: <?=(new DateTime())->format(Valve::DATEFORMAT)?></p>
	</footer>

	<div class="debug">
        <p class="copy">Debug information:</p>
		<?php 
		if (isset($_GET)) { echo '<pre>GET: '; print_r($_GET); echo '</pre>'; }
		if (isset($_POST)) { echo '<pre>POST: '; print_r($_POST); echo '</pre>'; }
		if (isset($Valve)) { echo '<pre>Valve: '; print_r($Valve); echo '</pre>'; }
		if (isset($_SERVER)) { echo '<pre>Server: '; print_r($_SERVER); echo '</pre>'; }
		?>
	</div>
</body>
</html>
	